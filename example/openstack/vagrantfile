# to run: VAGRANT_VAGRANTFILE=rocky.vagrantfile vagrant up
# Vagrant will create ssh key pair on ~/.vagrant.d/insecure_private_keys/vagrant.key.rsa
# ssh to vagrant: vagrant ssh
# manual ssh ssh -i ~/.vagrant.d/insecure_private_keys/vagrant.key.rsa vagrant@localhost -p 2222

Vagrant.configure("2") do |config|
  config.vm.provider "docker" do |d|
    d.name = "kolla-ansible"
    d.image = "rocky-onxp"
    d.has_ssh = true
    d.remains_running = true
  end

  config.vm.provision "shell", inline: <<-SHELL
    sudo dnf update -y && \
    sudo dnf install -y openssh-server && \
    sudo mkdir /var/run/sshd && \
    sudo echo 'root:root' | chpasswd && \
    sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

    sudo useradd -m -s /bin/bash vagrant && \
    sudo echo 'vagrant:vagrant' | chpasswd && \
    sudo mkdir -p /home/vagrant/.ssh && \
    sudo chmod 0700 /home/vagrant/.ssh

    sudo cp vagrant.key.pub /home/vagrant/.ssh/id_rsa.pub
    sudo cat /home/vagrant/.ssh/id_rsa.pub > /home/vagrant/.ssh/authorized_keys && \
    sudo chmod 0600 /home/vagrant/.ssh/authorized_keys && \
    sudo chown -R vagrant:vagrant /home/vagrant/.ssh
  SHELL

  # prepare VM to ready to use Kolla Ansibe
  config.vm.provision "ansible" do |ansible|
    ansible.playbook = "./kolla-playbook.yaml"
  end

  config.vm.synced_folder "./app", "/home/vagrant/app"
  config.vm.network "forwarded_port", guest: 22, host: 2222, id: "ssh"
  config.ssh.insert_key = false
end